<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Marquer présence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
<div class="container">
    <h4>Marquer la présence</h4>
    <div id="info" class="alert alert-info">En attente...</div>
    <div id="result" class="alert d-none"></div>
    <div>
        <p><strong>Session:</strong> <span id="sessionLabel">-</span></p>
        <p><strong>Nom:</strong> <span id="nameLabel">-</span></p>
        <p><strong>ID:</strong> <span id="identLabel">-</span></p>
    </div>
    <div class="mb-3">
        <button id="confirmBtn" class="btn btn-success">Confirmer la présence</button>
        <a href="index.html" class="btn btn-secondary ms-2">Retour</a>
    </div>
    <p class="text-muted small">Si la page indique une erreur de configuration Firebase, ouvrez `index.html` sur l'ordinateur enseignant et collez la configuration Firebase (console.Firebase).</p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
    function qs(name) { const u = new URL(location.href); return u.searchParams.get(name); }
    const session = qs('session');
    const name = qs('name');
    const ident = qs('ident');
    document.getElementById('sessionLabel').innerText = session || '(aucune)';
    document.getElementById('nameLabel').innerText = name || '(anonyme)';
    document.getElementById('identLabel').innerText = ident || '';

    function initFirebaseFromStorage() {
        try {
            const raw = localStorage.getItem('firebase_config');
            if (!raw) return false;
            const cfg = JSON.parse(raw);
            if (!cfg || !cfg.apiKey) return false;
            firebase.initializeApp(cfg);
            return true;
        } catch(e) { return false; }
    }

    async function writeCheckin() {
        if (!initFirebaseFromStorage()) { showError('Configuration Firebase introuvable. Demandez à l\'enseignant d\'ajouter la config via la page principale.'); return; }
        if (!session) { showError('Session manquante dans l\'URL'); return; }
        const db = firebase.database();
        const ref = db.ref('sessions/' + session + '/checkins');
        const payload = { name: name || 'inconnu', ident: ident || '', status: 'present', time: new Date().toISOString() };
        try {
            await ref.push(payload);
            showSuccess('Présence enregistrée — merci !');
        } catch(e) { showError('Erreur en écriture: ' + e.message); }
    }

    function showError(msg) { const r = document.getElementById('result'); r.className = 'alert alert-danger'; r.innerText = msg; r.classList.remove('d-none'); document.getElementById('info').classList.add('d-none'); }
    function showSuccess(msg) { const r = document.getElementById('result'); r.className = 'alert alert-success'; r.innerText = msg; r.classList.remove('d-none'); document.getElementById('info').classList.add('d-none'); }

    document.getElementById('confirmBtn').addEventListener('click', writeCheckin);
    // auto-submit if all params present
    if (session && name) setTimeout(writeCheckin, 800);
</script>
</body>
</html>
